#!/usr/bin/env php
<?php

declare(strict_types=1);

use Koriym\AppStateDiagram\ConfigFactory;
use Koriym\AppStateDiagram\Diagram;
use Koriym\AppStateDiagram\Exception\AlpsFileNotReadableException;
use Koriym\AppStateDiagram\PathResolver;
use Koriym\AppStateDiagram\PutDiagram;
use Koriym\DataFile\Exception\DataFileNotFoundException;

foreach ([__DIR__ . '/../../../autoload.php', __DIR__ . '/../vendor/autoload.php'] as $file) {
    if (file_exists($file)) {
        require $file;

        break;
    }
}
if ($argc === 1) {
    echo <<<EOT
usage: asd [options] alps_file

Options:
  -c, --config <path>     Use custom config file
  -e, --echo              Output to stdout instead of file
  -w, --watch             Watch mode with live reload
  -m, --mode <mode>       Output mode (html|markdown|svg)
  --port <port>           Port for watch mode (default: 3000)
  --validate              Validate ALPS profile (JSON output)
  --mcp                   Start MCP server for Claude Desktop integration
  -v, --version           Show version information
  -h, --help              Show this help message

@see https://github.com/alps-asd/app-state-diagram#usage

EOT;
    exit(0);
}
$options = getopt('c:e::w::m::v', ['config:', 'echo::', 'watch::', 'mode::', 'port::', 'validate', 'mcp', 'version']);
// Handle --version option
if (isset($options['v']) || isset($options['version'])) {
    $pharRunning = Phar::running(false);

    if ($pharRunning !== '') {
        // Try to extract version from Homebrew Cellar path
        if (preg_match('#/Cellar/asd/([^/]+)/#', $pharRunning, $matches)) {
            echo "asd version {$matches[1]} (Homebrew)\n";
        } else {
            echo "asd (PHAR version - version info not available)\n";
        }
    } else {
        echo "asd (development version - version info not available)\n";
    }
    exit(0);
}

// Handle --mcp option (MCP Server mode)
if (isset($options['mcp'])) {
    $pharRunning = Phar::running(false);
    $mcpServerPath = null;

    if ($pharRunning !== '') {
        // PHAR execution: look in libexec
        $pharDir = dirname($pharRunning);
        $mcpServerPath = $pharDir . '/mcp/asd-mcp.php';

        // Try version-independent opt path
        if (!file_exists($mcpServerPath)) {
            $homebrewPrefix = PathResolver::getHomebrewPrefix();
            if ($homebrewPrefix !== null) {
                $optPath = $homebrewPrefix . '/opt/asd/libexec/mcp/asd-mcp.php';
                if (file_exists($optPath)) {
                    $mcpServerPath = $optPath;
                }
            }
        }
    } else {
        // Development: look relative to bin/asd
        $mcpServerPath = dirname(__DIR__) . '/mcp/asd-mcp.php';
    }

    if ($mcpServerPath === null || !file_exists($mcpServerPath)) {
        fwrite(STDERR, "Error: MCP server not found at expected path.\n");
        if ($mcpServerPath !== null) {
            fwrite(STDERR, "Expected path: $mcpServerPath\n");
        }
        exit(1);
    }

    // Execute the MCP server - it will handle STDIN/STDOUT communication
    passthru("php " . escapeshellarg($mcpServerPath), $exitCode);
    exit($exitCode);
}

// Handle --validate option
if (isset($options['validate'])) {
    // Get the ALPS file from remaining arguments
    $alpsFile = null;
    $skipNext = false;
    $optionsWithValues = ['c' => true, 'config' => true, 'm' => true, 'mode' => true, 'port' => true];

    for ($i = 1; $i < $argc; $i++) {
        $arg = $argv[$i];

        if ($skipNext) {
            $skipNext = false;
            continue;
        }

        if ($arg === '--validate') {
            continue;
        }

        // Check for options that take values
        if (strpos($arg, '-') === 0) {
            $optionName = ltrim($arg, '-');
            if (isset($optionsWithValues[$optionName])) {
                $skipNext = true;
            }
            continue;
        }

        $alpsFile = $arg;
        break;
    }

    if ($alpsFile === null) {
        echo "Error: No ALPS file specified\n";
        echo "Usage: asd --validate <alps_file>\n";
        exit(1);
    }

    if (!file_exists($alpsFile)) {
        echo "Error: File not found: $alpsFile\n";
        exit(1);
    }

    // Find alps2dot CLI
    $pharRunning = Phar::running(false);
    $alps2dotPath = null;

    if ($pharRunning !== '') {
        // PHAR execution: look in libexec
        $pharDir = dirname($pharRunning);
        $alps2dotPath = $pharDir . '/alps2dot/dist/cli.js';

        // Try version-independent opt path
        if (!file_exists($alps2dotPath)) {
            $homebrewPrefix = PathResolver::getHomebrewPrefix();
            if ($homebrewPrefix !== null) {
                $optPath = $homebrewPrefix . '/opt/asd/libexec/alps2dot/dist/cli.js';
                if (file_exists($optPath)) {
                    $alps2dotPath = $optPath;
                }
            }
        }
    } else {
        // Development: look relative to bin/asd
        $alps2dotPath = dirname(__DIR__) . '/alps2dot/dist/cli.js';
    }

    if ($alps2dotPath === null || !file_exists($alps2dotPath)) {
        echo "Error: alps2dot not found. Please ensure Node.js components are installed.\n";
        exit(1);
    }

    $alpsFileEscaped = escapeshellarg(realpath($alpsFile));
    passthru("node " . escapeshellarg($alps2dotPath) . " validate $alpsFileEscaped", $exitCode);
    exit($exitCode);
}

if ($argc === 1) {
    $options['c'] = getcwd();
}
try {
    $configOption = $options['c'] ?? $options['config'] ?? null;
    $config = $configOption !== null ? ConfigFactory::fromFile($configOption, $argc, $argv, $options) : ConfigFactory::fromCommandLine($argc, $argv, $options);
} catch (DataFileNotFoundException $e) {
    printf('Config file not found: %s', $e->getMessage());
    exit(1);
} catch (AlpsFileNotReadableException $e) {
    printf('Profile file not found: %s', $e->getMessage());
    exit(1);
}
if ($config->watch) {
    $pharRunning = Phar::running(false);
    $actualPath = dirname(__DIR__) . '/asd-sync';
    
    if ($pharRunning !== '') {
        // PHAR execution: use version-independent opt path for better compatibility
        // PHAR path: "/opt/homebrew/Cellar/asd/x.x.x/libexec/asd.phar"
        // Target:    "/opt/homebrew/opt/asd/libexec/asd-sync" (version-independent)
        $pharDir = dirname($pharRunning);
        $actualPath = $pharDir . '/asd-sync';
        
        // Try version-independent opt path if not found in Cellar
        if (!is_dir($actualPath)) {
            $homebrewPrefix = PathResolver::getHomebrewPrefix();
            if ($homebrewPrefix !== null) {
                $optPath = $homebrewPrefix . '/opt/asd/libexec/asd-sync';
                if (is_dir($optPath)) {
                    $actualPath = $optPath;
                }
            }
        }
    }
    
    if (!is_dir($actualPath)) {
        echo "Error: asd-sync directory not found. Watch mode requires Node.js components.\n";
        echo "Expected path: $actualPath\n";
        exit(1);
    }
    
    chdir($actualPath);
    $nodeModulesPath = $actualPath . '/node_modules';
    $isFirstRun = !is_dir($nodeModulesPath);
    if ($isFirstRun) {
        echo "Installing Node.js dependencies...\n";
        passthru('npm install');
    }

    passthru("npm start -- --profile {$config->profile} --port {$config->port}");
    exit(0);
}

try {
    $index = (new Diagram())($config);
    $isEcho =  (isset($options['e']) || isset($options['echo']));
    if ($isEcho) {
        echo $index->content;
        exit;
    }
    // Don't generate HTML file for SVG mode
    if ($config->outputMode !== 'svg') {
        file_put_contents($index->file, $index->content);
        echo "ASD generated. {$index->file}" . PHP_EOL;
    }
} catch (Exception $e) {
    $shortName = (new \ReflectionClass($e))->getShortName();
    $msg = sprintf("asd: %s(%s)",$shortName, $e->getMessage());
    file_put_contents('php://stderr', $msg . PHP_EOL);
    exit(1);
}
